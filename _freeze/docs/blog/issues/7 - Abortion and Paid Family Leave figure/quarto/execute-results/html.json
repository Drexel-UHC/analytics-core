{
  "hash": "522e02f761ff0f107a62dffed7022616",
  "result": {
    "markdown": "---\nauthor: Ran Li\ndate: \"8/10/2022\"\ntitle: \"Visualization faceted by state\"\ndescription: \"Prototype a Abortion and Paid Family Leave Figure using geofacet\"\ncategories:\n  - visualization \n  - infographic\nformat: \n  html:\n    toc: true\n    toc-location: left\n    df-print: paged\n    code-fold: true\n    code-tools: true\nexecute: \n  warning: false\neditor_options: \n  chunk_output_type: console\n---\n\n\n# Issue\n\n**URL: https://github.com/Drexel-UHC/analytics-core/issues/7**\n\n> I'm hoping to make a figure that shows different policy statuses of states (abortion ban, proposed abortion ban, no abortion ban; Paid family leave, no paid family leave; paid family leave preemption, no preemption), with the states in the location of the US map...\n>\n> I think geofacet mightttt get us close to the figure I'm hoping to make, but not quitee there.\n\n# Example\n\n![](images/paste-24B14202.png){fig-align=\"center\"}\n\n# Evaluation\n\nJust a brief breakdown of the plot above from the [original article](https://www.scientificamerican.com/article/graphic-many-states-that-restrict-or-ban-abortion-dont-teach-kids-about-sex-and-pregnancy/). There are two layers: 1) rectangles show abortion policy categories 2) triangles show various degrees of coverage within sexual education by topic (contraception in blue vs abstinence in orange). In other words larger/more-orange triangle at bottom indicates more sexual seduction emphasize abstinence and large/more-blue triangle at top indicates more sexual education emphasis on contraception. In terms of data there each state would have three points: abortion policy categories, coverage of contraception, coverage of abstinence.\n\nLets take a look at the data sent over along with this request.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(janitor)\nlibrary(readxl)\nlibrary(tidyverse)\nlibrary(geofacet)\nlibrary(cowplot)\n\n## raw data\nraw_data = readxl::read_excel(path = \"raw-data/family medical leave preemption dataset.xlsx\",\n                              sheet = 'Sheet2') %>% \n  drop_na() %>% \n  select(name = 1, family_leave = 2, preemption = 3, abortion_ban_risk = 4)  %>% \n  mutate_all(~as.character(.x))\n\n## clean state codes\nxwalk_states = geofacet::state_ranks %>% \n  select(name, state) %>% \n  distinct()\ndata = raw_data %>% \n  mutate(name = name %>% recode(\"Washington DC\" = \"District of Columbia\" )) %>% \n  left_join(xwalk_states)\ndata\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"name\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"family_leave\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"preemption\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"abortion_ban_risk\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"state\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"Alabama\",\"2\":\"0\",\"3\":\"1\",\"4\":\"1\",\"5\":\"AL\"},{\"1\":\"Alaska\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"AK\"},{\"1\":\"Arizona\",\"2\":\"0\",\"3\":\"0\",\"4\":\"3\",\"5\":\"AZ\"},{\"1\":\"Arkansas\",\"2\":\"0\",\"3\":\"1\",\"4\":\"1\",\"5\":\"AR\"},{\"1\":\"California\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"CA\"},{\"1\":\"Colorado\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"CO\"},{\"1\":\"Connecticut\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"CT\"},{\"1\":\"Delaware\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"DE\"},{\"1\":\"Florida\",\"2\":\"0\",\"3\":\"0\",\"4\":\"3\",\"5\":\"FL\"},{\"1\":\"Georgia\",\"2\":\"0\",\"3\":\"1\",\"4\":\"2\",\"5\":\"GA\"},{\"1\":\"Hawaii\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"HI\"},{\"1\":\"Idaho\",\"2\":\"0\",\"3\":\"0\",\"4\":\"2\",\"5\":\"ID\"},{\"1\":\"Illinois\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"IL\"},{\"1\":\"Indiana\",\"2\":\"0\",\"3\":\"1\",\"4\":\"0\",\"5\":\"IN\"},{\"1\":\"Iowa\",\"2\":\"0\",\"3\":\"1\",\"4\":\"0\",\"5\":\"IA\"},{\"1\":\"Kansas\",\"2\":\"0\",\"3\":\"1\",\"4\":\"0\",\"5\":\"KS\"},{\"1\":\"Kentucky\",\"2\":\"0\",\"3\":\"1\",\"4\":\"1\",\"5\":\"KY\"},{\"1\":\"Louisiana\",\"2\":\"0\",\"3\":\"0\",\"4\":\"4\",\"5\":\"LA\"},{\"1\":\"Maine\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"ME\"},{\"1\":\"Maryland\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"MD\"},{\"1\":\"Massachusetts\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"MA\"},{\"1\":\"Michigan\",\"2\":\"0\",\"3\":\"1\",\"4\":\"0\",\"5\":\"MI\"},{\"1\":\"Minnesota\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"MN\"},{\"1\":\"Mississippi\",\"2\":\"0\",\"3\":\"0\",\"4\":\"1\",\"5\":\"MS\"},{\"1\":\"Missouri\",\"2\":\"0\",\"3\":\"0\",\"4\":\"1\",\"5\":\"MO\"},{\"1\":\"Montana\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"MT\"},{\"1\":\"Nebraska\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NE\"},{\"1\":\"Nevada\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NV\"},{\"1\":\"New Hampshire\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NH\"},{\"1\":\"New Jersey\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NJ\"},{\"1\":\"New Mexico\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NM\"},{\"1\":\"New York\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NY\"},{\"1\":\"North Carolina\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"NC\"},{\"1\":\"North Dakota\",\"2\":\"0\",\"3\":\"0\",\"4\":\"2\",\"5\":\"ND\"},{\"1\":\"Ohio\",\"2\":\"0\",\"3\":\"0\",\"4\":\"1\",\"5\":\"OH\"},{\"1\":\"Oklahoma\",\"2\":\"0\",\"3\":\"1\",\"4\":\"1\",\"5\":\"OK\"},{\"1\":\"Oregon\",\"2\":\"1\",\"3\":\"1\",\"4\":\"0\",\"5\":\"OR\"},{\"1\":\"Pennsylvania\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"PA\"},{\"1\":\"Rhode Island\",\"2\":\"1\",\"3\":\"1\",\"4\":\"0\",\"5\":\"RI\"},{\"1\":\"South Carolina\",\"2\":\"0\",\"3\":\"1\",\"4\":\"2\",\"5\":\"SC\"},{\"1\":\"South Dakota\",\"2\":\"0\",\"3\":\"0\",\"4\":\"1\",\"5\":\"SD\"},{\"1\":\"Tennessee\",\"2\":\"0\",\"3\":\"1\",\"4\":\"2\",\"5\":\"TN\"},{\"1\":\"Texas\",\"2\":\"0\",\"3\":\"0\",\"4\":\"2\",\"5\":\"TX\"},{\"1\":\"Utah\",\"2\":\"0\",\"3\":\"1\",\"4\":\"4\",\"5\":\"UT\"},{\"1\":\"Vermont\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"VT\"},{\"1\":\"Virginia\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"VA\"},{\"1\":\"Washington\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"WA\"},{\"1\":\"West Virginia\",\"2\":\"0\",\"3\":\"0\",\"4\":\"2\",\"5\":\"WV\"},{\"1\":\"Wisconsin\",\"2\":\"0\",\"3\":\"1\",\"4\":\"1\",\"5\":\"WI\"},{\"1\":\"Wyoming\",\"2\":\"0\",\"3\":\"0\",\"4\":\"0\",\"5\":\"WY\"},{\"1\":\"District of Columbia\",\"2\":\"1\",\"3\":\"0\",\"4\":\"0\",\"5\":\"DC\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nAdapting this visualization to the table above would give the following features:\n\n1.  The rectangle would be similiar with shade mapping to the abortion ban risk\n2.  The top blue triangle would map to family leave.\n3.  The bottom orange triangle would map to preemption family leave. I am assuming preemption is bad?\n\n# Proof of concept\n\nThe whole workflow relies on [`geofacet::face_geo()`](https://hafen.github.io/geofacet/). The main function in this package is facet_geo() and its use can be thought of as equivalent to ggplot2's facet_wrap() except for the output it creates. The first step is to create a function that creates the individual state plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Set coordinates\ncontainer_width_height = 10 # a 10 by 10 coordinate system\nrect_width = 6 \nrect_height = 3\nrect_xmin = 2\nrect_xmax = rect_xmin + rect_width\nrect_x_mean = mean(c(rect_xmin,rect_xmax))\nrect_ymin = 4\nrect_ymax = rect_ymin + rect_height \n\n## Append coordinates to data for geom_polygon\ndata_w_coords = data %>% \n  mutate(top_triangle_x = list(c(rect_xmin,rect_xmax,rect_x_mean)),\n         top_triangle_y = list(c(rect_ymax,rect_ymax,rect_ymax+rect_height)),\n         bottom_triangle_x = list(c(rect_xmin,rect_xmax,rect_x_mean)),\n         bottom_triangle_y = list(c(rect_ymin,rect_ymin,rect_ymin-rect_height))\n  ) %>% \n  unnest(cols = c(top_triangle_x, top_triangle_y, bottom_triangle_x, bottom_triangle_y))\n\n\n## create a function to make basic shapes\ngeom_hex_for_alina = function(data){\n  data %>% \n    ggplot()  + \n    geom_rect(aes(xmin = 0, xmax = 10, ymin = 0, ymax = 10),  fill = \"white\") + # 10 by 10 container\n    geom_rect(aes(xmin = rect_xmin, xmax = rect_xmax,ymin =rect_ymin, ymax = rect_ymax),    # add rectangle\n              color = \"black\", fill = \"grey\") +\n    geom_polygon(aes(x=top_triangle_x,y=top_triangle_y), fill = 'blue') + # top triangle\n    geom_polygon(aes(x = bottom_triangle_x, y = bottom_triangle_y),  fill = 'red') +   # bottom triangle\n    theme_void()\n}\n\n\n## Test function to plot for a single state\ndata_w_coords %>% \n  filter(name == \"Alabama\") %>% \n  geom_hex_for_alina()\n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nGreat now let's us this just append a [`geofacet::face_geo()`](https://hafen.github.io/geofacet/) to do do the by state faceting; note we are now passing all the states data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_w_coords %>% \n  geom_hex_for_alina() +\n  facet_geo(~ state) \n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nGreat I think this approach is getting us to what we want.\n\n# Ggplot code\n\nThere are a few things to do to polish it a bit.\n\n-   [x] display triangles based on the data features\n-   [x] display abortion ban risk as shade of triangle\n-   [x] minimize the inidividual plot margins (to make the layout more similiar to our example)\n-   [x] remove facet_wrap strip text/label\n-   [x] move the 2 letter state abbrv into the rectangle\n\n## Plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Set coordinates\nheight = 10 \npadding_x = 1\nwidth = 8\nrect_xmin = padding_x\nrect_xmax = width + padding_x\nrect_x_mean = mean(c(rect_xmin,rect_xmax))\nrect_ymin = height/3\nrect_ymax = rect_ymin*2\n\n## Manual colors for data features\nabortion_colors = c(\"0\" = \"#e7e8e9\",\n                    \"1\" = \"#c1c2c4\", \n                    \"2\" = \"#8a8c8f\",\n                    \"3\" = \"#5f6062\",\n                    \"4\" = \"#000000\")\nxwalk_colors = c(abortion_colors,\n                 \"white\" = \"white\",\n                 \"black\" = \"black\",\n                 \"0_family_leave\" = \"white\",\n                 \"1_family_leave\" = \"#00aeef\",\n                 \"0_preemption\" = \"white\",\n                 \"1_preemption\" = \"#f1592a\")     \n\n## Operationalize data for plot\ndata_processed = data %>% \n  ## Append coordinates to data for geom_polygon\n  mutate(top_triangle_x = list(c(rect_xmin,rect_xmax,rect_x_mean)),\n         top_triangle_y = list(c(rect_ymax,rect_ymax,height)),\n         bottom_triangle_x = list(c(rect_xmin,rect_xmax,rect_x_mean)),\n         bottom_triangle_y = list(c(rect_ymin,rect_ymin,0))\n  ) %>% \n  unnest(cols = c(top_triangle_x, top_triangle_y, bottom_triangle_x, bottom_triangle_y)) %>% \n  ## operationalize colors\n  mutate(\n    state_text = ifelse(as.numeric(abortion_ban_risk)>2, \"white\",\"black\"),\n    family_leave = paste0(family_leave,\"_family_leave\"),\n    preemption = paste0(preemption,\"_preemption\"))\n\n\n## create a function to make basic shapes\ngeom_hex_for_alina = function(gg){\n  gg +\n    ## add rectangle\n    geom_rect(aes(xmin = rect_xmin, xmax = rect_xmax,   \n                  ymin = rect_ymin, ymax = rect_ymax, \n                  fill = abortion_ban_risk)) +\n    ## Add state abbrv text\n    geom_text(aes(label = state, color = state_text),\n              x = height/2, y = height/2,\n              size = 3)+\n    ## Top triangle (family leave)\n    geom_polygon(aes(x=top_triangle_x,y=top_triangle_y, fill = family_leave)) + \n    ## Bottom triangle (preemption)\n    geom_polygon(aes(x = bottom_triangle_x, y = bottom_triangle_y, fill = preemption)) +   \n    ## Manual colors\n    scale_fill_manual(values = xwalk_colors) +\n    scale_color_manual(name = \"state_text\", values = xwalk_colors) +\n    theme_void()+ \n    theme(\n      ## Completely remove facet labels\n      strip.background = element_blank(),\n      strip.text.x = element_blank(),\n      ## Remove legend\n      legend.position = 'none'\n    )\n}\n\n## Test facet\nplot = data_processed %>% \n  ggplot()  %>% \n  geom_hex_for_alina() +\n  facet_geo(~ state, grid = \"us_state_grid2\") +\n  theme(plot.margin = margin(1, 1, 1, 1, \"cm\"))\nplot\n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## Legend 1: Rectangle\n\n\n::: {.cell}\n\n```{.r .cell-code}\nside = 10 \npadding = 1.5\nrect_width =  (side - 2*padding)/5\nlegend_y = 6\nlegend_height = 1.5\ndfa = tibble(xmin = padding + 0:4*rect_width,\n             xmax = padding + 1:5*rect_width,\n             ymin = legend_y,\n             ymax = legend_y + legend_height,\n             fill = unname(abortion_colors))\nlegend_risk = ggplot() + \n  ## Container (10 by 10)\n  geom_rect(aes(xmin = 0, xmax = 10, \n                ymin = 0, ymax = 10),\n            fill = \"white\") + \n  ## Legend for rectangles\n  geom_rect(dfa, mapping = \n              aes(xmin = xmin, xmax = xmax, \n                  ymin = ymin, ymax = ymax),\n            fill = dfa$fill) + \n  ## Left label\n  geom_text(aes(label = \"Less risk\"),\n            x = side/5, y = legend_y - 1,\n            size = 3) +\n  ## Rigth label\n  geom_text(aes(label = \"More risk\"),\n            x = 4*side/5, y = legend_y -1,\n            size = 3) +\n  theme_void()\n\ntitle_rect <- ggdraw() + \n  draw_label(\n    \"Rectangle show \\n abortion ban risk\",\n    fontface = 'bold',\n    x = 0.5,\n    hjust = 0.5,\n    size = 10\n  ) +\n  theme(\n    # add margin on the left of the drawing canvas,\n    # so title is aligned with left edge of first plot\n    plot.margin = margin(5, 0, 0, 0)\n  )\nrect_legend = plot_grid(\n  title_rect, legend_risk,\n  ncol = 1,\n  rel_heights = c(2, 8)\n)\n\nrect_legend\n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## Legend 2: Paid family leave\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Create funciton to layout for legend\ngeom_hex_legend_for_alina = function(gg){\n  gg +\n    geom_rect(aes(xmin =  0 - 1*height, xmax = height + 1*height,   \n                  ymin = 0 - 1*height, ymax = height + 1*height),\n              fill = \"white\") \n}\n\n## Legend 2: Blue triangle\ntitle_hex_blue <- ggdraw() + \n  draw_label(\n    \"Blue Triangles show \\n paid family policy\",\n    fontface = 'bold',\n    x = 0.5,\n    hjust = 0.5,\n    size = 10\n  ) +\n  theme( plot.margin = margin(5, 0, 0, 0))\nlegend_hex_blue = data_processed %>% \n  filter(state == \"WA\") %>% \n  mutate(state = \"\") %>% \n  ggplot()  %>% \n  geom_hex_legend_for_alina() %>% \n  geom_hex_for_alina()\nhex_legend_blue = plot_grid(\n  title_hex_blue, legend_hex_blue,\n  ncol = 1,\n  rel_heights = c(2, 8)\n)\n\nhex_legend_blue\n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n## Legend 3: Preemption\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Legend 3: Red triangle\ntitle_hex_red <- ggdraw() + \n  draw_label(\n    \"Blue Triangles show \\n preemption policy\",\n    fontface = 'bold',\n    x = 0.5,\n    hjust = 0.5,\n    size = 10\n  ) +\n  theme(\n    plot.margin = margin(5, 0, 0, 0)\n  )\nlegend_hex_red = data_processed %>% \n  filter(state == \"MI\") %>% \n  mutate(state = \"\") %>% \n  ggplot()  %>% \n  geom_hex_legend_for_alina() %>% \n  geom_hex_for_alina()\nhex_legend_red = plot_grid(\n  title_hex_red, legend_hex_red,\n  ncol = 1,\n  rel_heights = c(2, 8)\n)\nhex_legend_red\n```\n\n::: {.cell-output-display}\n![](quarto_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n# Final Layout\n\nThis is saved in \"./output/issue5.jpeg\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle =  ggdraw() + \n  draw_label(\n    \"Abortion, Paid Family Leave and Preemption Policy by U.S. State\",\n    fontface = 'bold',\n    x = 0.5,\n    hjust = 0.5,\n    size = 14\n  ) +\n  theme_void()+\n  theme( plot.margin = margin(0, 0, 0, 0),\n         plot.background = element_rect(fill = \"#f2f2f2\", colour = 'white' ),\n        \n         )\n\nlegend = plot_grid(NULL, rect_legend,hex_legend_blue,hex_legend_red,\n                   ncol = 4,\n                   rel_widths = c(0.2, 1, 1, 1))\n\n\nfigure = plot_grid(title,\n                   NULL,\n                   legend,\n                   NULL,\n                   plot,\n                   ncol = 1,\n                   rel_heights = c(0.5,0.2,2,0.2,7)) \n \n\nggsave(filename = \"output/issue5.jpeg\",\n       plot = figure,\n       height = 8,\n       width = 8\n       )\n```\n:::\n\n\n![](output/issue5.jpeg){fig-align=\"center\"}\n",
    "supporting": [
      "quarto_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}